generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Author {
  id          Int     @id @default(autoincrement())
  name        String @unique
  website     String?
  group       String?
  profile     String?
  masterpiece String?
  posts       Post[]
  authorTwitter String?
  groupTwitter String?

  @@index([name])
  @@map("Author")
}

model Post {
  id                  Int             @id @default(autoincrement())
  title               String
  content             String?
  author_id           Int
  man                 Int?
  woman               Int?
  others              Int?
  totalNumber         Int?
  playtime            Int?
  synopsis            String?
  image_url           String?
  amazon_text_url     String?
  amazon_img_url      String?
  amazon_img_text_url String?
  link_to_plot        String?
  website1            String?
  website2            String?
  website3            String?
  ISBN_13             String?
  buy_link            String?
  comments      ParentComment[]
  access              Access[]
  averageRating Float?
  ratings   Rating[]
  author              Author          @relation(fields: [author_id], references: [id])
  categories          Category[]      @relation("PostCategory")

  @@index([title])
  @@index([synopsis])
  @@index([man])
  @@index([woman])
  @@index([totalNumber])
  @@index([playtime])
  @@index([averageRating])
  @@index([author_id])
  @@index([man, woman, totalNumber])
  @@index([playtime, averageRating])
  @@map("Post")
}

model Category {
  id    Int    @id @default(autoincrement())
  name  String @unique
  posts Post[] @relation("PostCategory")
  image_url String?
  contentMarkdown String?

  @@map("Category")
}

model News {
  id       Int      @id @default(autoincrement())
  date     DateTime @default(now())
  url      String?
  category String
  title    String

  @@map("News")
}

model Access {
  id        Int      @id @default(autoincrement())
  ipAddress String
  postId    Int
  date      DateTime @db.Date
  post      Post     @relation(fields: [postId], references: [id])

  @@unique([ipAddress, postId, date])
  @@map("Access")
}

model ParentComment {
  id          Int            @id @default(autoincrement())
  content     String
  deleted     Boolean        @default(false)
  post_id     Int
  author      String         @default("名無しさん")
  date        DateTime       @default(now())
  likes       Int            @default(0)
  commentType String?
  children    ChildComment[]
  post        Post           @relation(fields: [post_id], references: [id])

  @@map("ParentComment")
}

model ChildComment {
  id              Int           @id @default(autoincrement())
  content         String
  deleted         Boolean       @default(false)
  parentCommentId Int
  author          String        @default("名無しさん")
  date            DateTime      @default(now())
  likes           Int           @default(0)
  parentComment   ParentComment @relation(fields: [parentCommentId], references: [id])

  @@map("ChildComment")
}

model Rating {
  id        Int      @id @default(autoincrement())
  ipAddress String
  star      Float
  createdAt DateTime @default(now())
  postId    Int
  Post      Post     @relation(fields: [postId], references: [id])

  @@map("Rating")
}

model BlogPost {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  description String?
  content     String
  tags        String[]
  language    String   @default("ja")
  publishedAt DateTime
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([language])
  @@map("BlogPost")
}

// === 大学演劇 ===

enum UniversityType {
  NATIONAL    // 国立
  PUBLIC      // 公立
  PRIVATE     // 私立
}

enum Region {
  HOKKAIDO
  TOHOKU
  KANTO
  CHUBU
  KANSAI
  CHUGOKU_SHIKOKU
  KYUSHU_OKINAWA
}

enum TheaterGroupType {
  STUDENT       // 学生劇団
  INTERCOLLEGE  // インカレ
  ACADEMIC      // 大学学科
  AMATEUR       // アマチュア・社会人
  PROFESSIONAL  // プロ
  YOUTH         // ユース
}

model University {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  slug            String           @unique
  universityType  UniversityType
  prefecture      String
  region          Region
  website         String?
  theaterGroups   TheaterGroupUniversity[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([region])
  @@index([prefecture])
  @@index([universityType])
  @@map("University")
}

model TheaterGroup {
  id            Int                      @id @default(autoincrement())
  name          String
  slug          String                   @unique
  groupType     TheaterGroupType         @default(STUDENT)
  description   String?
  memberCount   Int?
  foundedYear   Int?
  prefecture    String?
  region        Region?
  website       String?
  twitter       String?
  instagram     String?
  corich        String?
  otherLinks    String[]
  isActive      Boolean                  @default(true)
  blogPostSlug  String?
  universities  TheaterGroupUniversity[]
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  @@index([groupType])
  @@index([isActive])
  @@index([prefecture])
  @@index([region])
  @@map("TheaterGroup")
}

model TheaterGroupUniversity {
  id              Int          @id @default(autoincrement())
  theaterGroupId  Int
  universityId    Int
  campus          String?
  theaterGroup    TheaterGroup @relation(fields: [theaterGroupId], references: [id])
  university      University   @relation(fields: [universityId], references: [id])

  @@unique([theaterGroupId, universityId])
  @@index([theaterGroupId])
  @@index([universityId])
  @@map("TheaterGroupUniversity")
}

model Announcement {
  id               Int      @id @default(autoincrement())
  title            String
  content          String
  performanceDate  DateTime?
  venue            String?
  ticketPrice      String?
  contactInfo      String?
  authorName       String   @default("名無しさん")
  ipAddress        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  views            Int      @default(0)
  
  @@index([createdAt(sort: Desc)])
  @@index([performanceDate])
  @@index([views(sort: Desc)])
  @@map("Announcement")
}